<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="nav-item.html">

<dom-module id="c-main-navigation">
  <template>

      <style>

        :host .navbar-collapse {
            min-height: 53px;
            padding: 0;
            font-family: 'Scania Sans Bold';
        }
        :host-context(.app) ::content nav-item a {
            padding-top: 16px;
            padding-bottom: 16px;
        }
        @media (max-width: 991px) {
            :host .navbar-collapse {
                background-color: #f5f5f5;
                border-top: 0px;
                padding: 0;
                font-size: 1.2rem;
            }
            :host-context(.app) ::content nav-item a {
                padding: 10px 25px;
                margin-left: 0;
                border-bottom: 1px solid #e2e2e2;
            }
        }
        :host {
            display: none;
            transition: height 100ms ease;
            --more-visibility: hidden;
        }
        :host .navbar-footer {
            display: none;
        }
        :host .navbar-collapse {
            /*font-size: 0;*/
        }
        :host ::content primary-items {
            display: inline-block;
        }
        :host ::content secondary-items {
            display: inline-block;
        }
        :host ::content nav-item {
            font-size: 1.4rem;
            vertical-align: middle;
        }
        :host ::content primary-items > nav-item > a,
        :host ::content secondary-items > nav-item > a {
            overflow: hidden;
        }
        :host ::content > .navbar {
            /*min-height: inherit;*/
            box-shadow: 0 0 0 0 transparent;
            transition: box-shadow 0.15s ease-in-out;
        }
        :host ::content .navbar-nav.navbar-right:last-child {
            margin-right: 0;
        }
        :host ::content .more {
            visibility: var(--more-visibility);
        }
        :host ::content .more > a {
            display: block;
        }
        :host ::content .more li {
            display: none;
        }
        :host ::content .more li a {
            text-transform: uppercase;
        }
        :host ::content .dropdown-menu {
            max-height: 70vh;
            overflow-y: auto;
            z-index: 1001;
            -webkit-box-shadow: 0 9px 12px rgba(0, 0, 0, 0.175);
            box-shadow: 0 9px 12px rgba(0, 0, 0, 0.175);
        }
        :host ::content .dropdown-menu a {
            padding-top: 9px;
            padding-bottom: 9px;
            text-transform: none;
            font-weight: bold;
        }
        :host ::content .dropdown-menu a:hover {
            background-color: transparent;
        }
        :host-context(.app) ::content nav-item:first-child a:before {
            padding-left: 0;
        }
        :host-context(.app) ::content nav-item .dropdown-menu a {
            padding-top: 7px;
            padding-bottom: 7px;
        }
        :host-context(.header-is-sticky) ::content > .navbar {
            position: fixed;
            top: -1px;
            left: 0;
            right: 0;
            -webkit-box-shadow: 0 2px 10px 0 rgba(0, 0, 0, 0.15);
            box-shadow: 0 2px 10px 0 rgba(0, 0, 0, 0.15);
        }
        :host-context(.header-is-sticky) ::content .navbar-nav.navbar-right {
            padding-right: 80px;
        }
        :host-context(body.fullscreen) ::content .navbar-nav.navbar-right {
            margin-right: 1px;
        }
        :host-context(.app.header-is-sticky) ::content .navbar-nav.navbar-right {
            padding-right: 60px;
        }
        @media (max-width: 991px) {
            :host {
                min-height: auto !important;
            }
            :host .navbar-footer {
                height: 55px;
            }
            :host .navbar-footer ::content nav-item {
                padding-left: 0;
                padding-right: 0;
                margin: 0;
            }
            :host .navbar-footer ::content nav-item a {
                padding-top: 15px;
                padding-bottom: 15px;
            }
            :host .navbar-toggle {
                display: inline-block;
                float: left;
                border: 1px solid #e2e2e2;
                padding: 0;
                margin: 0 0 -1px;
                border-radius: 0;
            }
            :host .navbar-toggle:hover {
                background-color: transparent;
            }
            :host .navbar-toggle ::content a {
                padding: 19px;
                font-size: 1.4em;
            }
            :host .navbar-toggle ::content a:hover,
            :host .navbar-toggle ::content a:focus {
                color: inherit;
                outline: none;
            }
            :host .navbar-toggle ::content a.collapsed .icon-expander:before {
                content: "\e6b1";
            }
            :host .navbar-toggle ::content a > span {
                padding: 0;
                border-left: 0;
            }
            :host .navbar-toggle ::content a .icon-expander {
                display: inline-block;
                width: 18px;
            }
            :host .navbar-toggle ::content a .icon-expander:before {
                content: "\e60d";
            }
            :host nav .navbar-collapse {
                overflow: visible;
            }
            :host nav .navbar-collapse.collapsing {
                overflow-y: hidden !important;
            }
            :host nav .navbar-collapse.collapsing + .navbar-footer {
                display: block;
            }
            :host nav .navbar-collapse.collapse {
                display: none;
            }
            :host nav .navbar-collapse.collapse.in {
                display: block;
            }
            :host nav .navbar-collapse.collapse.in + .navbar-footer {
                display: block;
            }
            :host > .navbar-default {
                display: none;
                min-height: 0;
            }
            :host ::content nav-item a {
                padding-top: 25px;
                padding-bottom: 25px;
            }
            :host ::content nav-item a:focus {
                color: inherit;
            }
            :host ::content nav-item a > span {
                border-left: 0;
                padding-left: 2rem;
                padding-right: 2rem;
            }
            :host ::content nav-item a > span[class^="icon-"] {
                line-height: inherit;
            }
            :host ::content primary-items {
                display: block;
            }
            :host ::content primary-items > nav-item {
                background-color: #f5f5f5;
                position: relative;
            }
            :host ::content primary-items > nav-item > a:hover span {
                text-decoration: none;
            }
            :host ::content secondary-items {
                display: block;
            }
            :host ::content secondary-items > nav-item {
                padding: 0;
                position: relative;
            }
            :host ::content secondary-items > nav-item a {
                padding: 10px 30px;
            }
            :host ::content secondary-items > nav-item a span {
                padding: 0;
            }
            :host ::content primary-items > nav-item,
            :host ::content secondary-items > nav-item {
                display: flex;
                flex-direction: column;
            }
            :host ::content .nav {
                float: none !important;
            }
            :host ::content .navbar-left:hover ::content nav-item a,
            :host ::content .navbar-left:hover ::content ~ c-navbar nav-item a,
            :host ::content .navbar-left:hover ::content ~ sub-navigation nav-item a {
                color: #041e42;
            }
            :host ::content .nav-collapse-container {
                height: 100%;
                background-color: #f5f5f5;
                overflow-y: auto;
                -ms-overflow-style: auto;
            }
            :host ::content .more {
                display: none !important;
            }
            :host ::content .dropdown-menu {
                overflow: visible;
                box-shadow: none;
                border: 0;
                padding: 0;
            }
            :host ::content .dropdown-menu a {
                border-bottom: 1px solid #e2e2e2;
                padding-left: 25px;
                padding-right: 25px;
            }
            :host-context(.navigation-open) > .navbar-default {
                display: block;
            }
        }

      </style>

      <nav class="navbar navbar-default">
          <div class="collapse navbar-collapse" id="main-navigation">
            <primary-items class="nav navbar-nav">
              <content select="primary-items" id="primary-items"></content>

              <template is="dom-repeat" items="{{_primaryItems}}">
                <nav-item href$="{{item.href}}" title$="{{item.title}}" class$="{{dashed(item.title)}}"></nav-item>
              </template>

              <nav-item text="{{moreText}}" items="{{moreItems}}" dropdown="true" class="more"></nav-item>
            </primary-items>

            <secondary-items class="nav navbar-nav navbar-right">
              <content select="secondary-items" id="secondary-items"></content>

              <template is="dom-repeat" items="{{_secondaryItems}}">
                <nav-item href="{{item.href}}" title="{{item.title}}" class$="dropdown {{dashed(item.title)}}" dropdown="{{items.length}}"></nav-item>
              </template>
            </secondary-items>
          </div>
      </nav>

  </template>

  <script>
  Polymer({
      is: 'c-main-navigation',

      properties: {
          siteName: String,
          siteUrl: String,
          showSearch: false,
          dealerLocator: false,
          moreItemsAvailable: {
              type: Boolean,
              value: false,
              observer: 'initMoreItem'
          },
          moreItems: {
              type: Array,
              value: []
          },
          moreText: {
              type: String,
              value: 'More'
          },
          fullbleed: {
              type: Boolean,
              value: true
          },
          primaryItems: {
              type: Array,
              value: [],
              observer: 'setPriItemIndex'
          },
          _primaryItems: {
              type: Array
          },
          secondaryItems: {
              type: Array,
              value: [],
              observer: 'setSecItemIndex'
          },
          _secondaryItems: {
              type: Array
          }
      },
      listeners: {
          'navItem-active': 'setItemActive',
          'navItemDropdown-active': 'setMoreItemActive',
          'subNavigation-attached': 'setHeaderSize',
          'moreItem-toggled': 'setMoreItems',
          'navigation-close': 'navigationClose'
      },
      created: function() {
          this.header = document.querySelector('c-corporate-header');

          [].slice.call(this.querySelectorAll('primary-items, secondary-items')).map(function(elm) {
              elm.classList.add('nav', 'navbar-nav')
          })

          if (this.querySelector('secondary-items')) {
              this.querySelector('secondary-items').classList.add('navbar-right');
          }

          // The timeout here is used to delay the callback until template is fully rendered
          setTimeout((function() {
              this.sticky.call(this);
              this.setHeaderSize.call(this);
              this.setMoreItems.call(this);
          }).bind(this));

          // reducer
          /*function reducer(state = [], action:any = {}) {
           switch (action.type) {
           case 'navigation/ADD_NAV_ITEM':
           return [...state, { ...action.payload, id: state.length+1 }];
           case 'navigation/REMOVE_NAV_ITEM':
           return state.slice(1);
           default:
           return state;
           }
           }

           store.register('navigation', reducer);*/
      },
      attached: function() {
          this.style.display = 'block';
          this.siteName = this.header.siteName;
          this.siteUrl = this.header.siteUrl;

          // If corporate-header exists tell the logotype to have sticky handling
          if (this.header) {
              this.header.sticky = 'should-stick';
          }

          this.itemsExist();

          var nav = this.querySelector('#main-navigation'),
                  styleElm = document.createElement('style');

          this.insertBefore(styleElm, this.children[0]);

          window.addEventListener('scroll', (function() {
              this.sticky.call(this)
              this.setMoreItems.call(this);
          }).bind(this));
          window.addEventListener('resize', (function() {
              this.setHeaderSize.call(this);
              this.setMoreItems.call(this);
          }).bind(this));
          document.addEventListener('fullscreen-toggled', this.fullscreenToggle.bind(this));
          nav.addEventListener('show.bs.collapse', function() {
              window.scrollTo(0, 0);
              document.body.classList.add('navigation-open');
          });
          nav.addEventListener('hidden.bs.collapse', (function() {
              document.body.classList.remove('navigation-open');
              this.setHeaderSize.call(this);
          }).bind(this));

          // Set start collapse value - couldnt get this to work in a better way...
          // this.querySelector('.navbar-toggle').classList.add('collapsed');

          // Special handling for Firefox 64 if application is using requirejs
          /* Handle all dom click events related to c-main-navigation */
          document.onclick = this.documentOnClick;
      },
      ready: function() {
          this.unwrap(this.getContentChildren('#primary-items')[0]);
          this.unwrap(this.getContentChildren('#secondary-items')[0]);
      },
      unwrap: function(node) {
          if (!node) {
              return
          }

          while (node.firstChild) {
              node.parentNode.insertBefore(node.firstChild, node);
          }
          for (var i = 0; i < node.attributes.length; i++) {
              var attrs = node.attributes[i],
                      val = node.parentNode.getAttribute(attrs.name) || '';
              node.parentNode.setAttribute(attrs.name, val + ' ' + attrs.value);
              // node.parentNode[attrs.name] = attrs.value;
          }
          node.parentNode.removeChild(node);
      },
      dashed: function(text) {
          return (text || '').toLowerCase().split(' ').join('-');
      },
      setItemActive: function(event) {
          var parent = event.target.parentNode,
                  gParent = event.target.parentNode.parentNode,
                  index = Array.prototype.indexOf.call(parent.children, event.target),
                  firstSubItem = event.target.querySelector('sub-navigation nav-item');

          // Stop here if current item is the more item
          /*if (event.target.dropdown) {
           event.target.active = false;
           return
           }*/
          /*parent.querySelector('.more').setActive()
           if(this.moreItems) {
           this.set('moreItems.' + index + '.active', true);
           }*/

          if (gParent.preActive && gParent.preActive !== event.target) {
              gParent.preActive.active = false;
          }

          if (firstSubItem) {
              firstSubItem.active = true;
          }

          gParent.preActive = event.target;

          // We should probably re think this interaction later on...
          if (gParent.id === 'main-navigation') {
              if(this.moreItems) {
                  this.moreItems.map((function(item, key) {
                      if (item.active) {
                          this.set('moreItems.' + key + '.active', false);
                      }
                  }).bind(this))
                  this.set('moreItems.' + index + '.active', true);
              }
          }

          // $('.navbar-toggle').trigger('click');
          this.setHeaderSize.call(this);
      },
      setActiveClass: function(active) {
          return active ? 'active' : '';
      },
      setHeaderSize: function() {
          var headerHeight = 'auto',
                  elm = this.querySelector('.navbar-toggle'),
                  elm2 = this.querySelector('.navbar-default'),
                  elm3 = this.querySelector('nav-item.active sub-navigation');

          // This is set to make min-height calculation correct.
          // The min-height of the child is otherwise inherited by the parent
          elm2.style.minHeight = 'auto';

          if (elm2 && elm2.offsetHeight) {
              headerHeight = elm2.offsetHeight;
              if (elm3 && elm3.offsetHeight) {
                  headerHeight += elm3.offsetHeight;
              }
          }

          if (elm && elm.getClientRects().length) {
              headerHeight = elm.offsetHeight
          }

//          if( parseInt(this.style.height) != parseInt(headerHeight) ) {
//              this.style.cssText ='display: block; min-height: ' + headerHeight + (isNaN(Number(headerHeight)) ? ';' : 'px;');
//          }

          this.querySelector('.navbar-default').removeAttribute('style');
      },
      setMoreItems: function() {
          var primary = this.querySelector('primary-items'),
                  secondary = this.querySelector('secondary-items'),
                  styleElm = this.querySelector('style') || {},
                  itemsWidth;

          if (window['moreItemDelay']) {
              clearTimeout(window['moreItemDelay']);
          }

          // We have a delay here to make sure the navigation
          // doesnt flicker on resize
          window['moreItemDelay'] = setTimeout((function() {
              styleElm.innerText = '';

              this.customStyle['--more-visibility'] = 'hidden';
              this.updateStyles();

              itemsWidth = primary.offsetWidth + (secondary ? secondary.offsetWidth + 2 : 0);
              if(itemsWidth >= this.offsetWidth) {
                  this.moreItemsAvailable = true;
              }
          }).bind(this), 20);
      },
      initMoreItem: function(val) {
          if(!val) {
              return;
          }

          // Async is used to make sure template has rerendered before
          // continuing. Else dropdown nav-item is not rendered
          this.async(function() {
              var primary = this.querySelector('primary-items'),
                      secondary = this.querySelector('secondary-items'),
                      styleElm = this.querySelector('style'),
                      dropdown = this.querySelector('.dropdown-toggle'),
                      availableSpace = this.offsetWidth - (secondary ? secondary.offsetWidth + 2 : 0),
              // We have -2 here because we dont want to count the template element or "More" nav-item
                      itemsChanged = primary.children.length - 2 !== this.moreItems.length;

              if (itemsChanged) {
                  this.moreItems = [];
              }

              this.customStyle['--more-visibility'] = 'visible';
              this.updateStyles();

              primary.style.width = ( availableSpace - (dropdown ? dropdown.offsetWidth : 0) ) + 'px';

              // We have -1 here to skip the "More" nav-item
              for(var i=0; i<primary.children.length - 1; i++) {
                  var item = primary.children[i],
                          node = item.querySelector('a');

                  if (item.nodeName !== 'NAV-ITEM') {
                      continue;
                  }

                  if(item.offsetTop && !styleElm.innerText) {
                      var css = '\
            @media (min-width: 992px) {\
              c-main-navigation primary-items > nav-item:nth-child(1n+' + i + ') > a { display: none; } \
              c-main-navigation .more li:nth-child(1n+' + i + ') { display: block !important; } \
            }';
                      if (styleElm.styleSheet){
                          styleElm.styleSheet.cssText = css;
                      } else {
                          styleElm.appendChild(document.createTextNode(css));
                      }
                  }

                  if (itemsChanged && node) {
                      this.push('moreItems', {
                          text: node.text,
                          location: node.getAttribute('href')
                      });
                  }
              }

              primary.removeAttribute('style');

              this.moreItemsAvailable = false;
              this.setHeaderSize.call(this);
          });
      },
      setMoreItemActive: function(event) {
          if (event.detail.navItem.classList.contains('more')) {
              var trigger = event.target.parentNode,
                      index = Array.prototype.indexOf.call(trigger.parentNode.children, trigger);

              this.querySelector('primary-items').children[index].active = true;
          }
      },
      navigationClose: function() {
          var hamburger = this.header.querySelector('.navbar-toggle');
          hamburger.Collapse.hide();
      },
      fullscreenToggle: function() {
          this.setHeaderSize();
          this.setMoreItems();
      },
      sticky: function() {
          var stickyNavTop = this.offsetTop,
                  scrollTop = typeof window.scrollY === 'undefined' ? window.pageYOffset : window.scrollY, // our current vertical position from the top
                  isSticky = document.body.classList.contains('header-is-sticky'),
                  event = document.createEvent('Event');

          if (scrollTop <= Math.max(stickyNavTop, 0)) {
              if (isSticky) {
                  document.body.classList.remove('header-is-sticky');
                  event.initEvent('navigation-not-sticky', true, true);
                  this.dispatchEvent(event);
              }
          } else {
              if (!isSticky) {
                  document.body.classList.add('header-is-sticky');
                  event.initEvent('navigation-is-sticky', true, true);
                  this.dispatchEvent(event);
              }
          }
      },
      itemsExist: function() {
          var priItems = (this.primaryItems || []).length,
                  secItems = (this.secondaryItems || []).length,
                  items = this.querySelectorAll('nav-item').length + priItems + secItems;

          // Show hamburger menu if item exist in main-navigation
          // One item is the "More item"
          if (this.header && items > 1) {
              this.header.hasMainNav = true;
          }
      },
      setItemIndex: function(val) {
          val = val.map(function(item, key) {
              item.index = item.index || 0;
              item.orgIndex = key;
              return item;
          });
          val.sort(this.sort);
          this.itemsExist();
          return val;
      },
      setPriItemIndex: function(val=[]) {
          if (!val.length) {
              return;
          }
          this._primaryItems = [];
          this.async((function() {
              this._primaryItems = this.setItemIndex(val);
              this.setMoreItems();
              this.primaryItems = [];
          }).bind(this));
      },
      setSecItemIndex: function(val=[]) {
          if (!val.length) {
              return;
          }
          this._secondaryItems = [];
          this.async((function() {
              this._secondaryItems = this.setItemIndex(val);
              this.setMoreItems();
              this.secondaryItems = [];
          }).bind(this));
      },
      sort: function(a, b) {
          // Compare item a and b origional index to
          // decide what item is first
          var order = a.orgIndex < b.orgIndex ? -1 : 1;

          // Compare user set index on item if they
          // dont match decide what item is first
          if (a.index < b.index) order = -1;
          if (a.index > b.index) order = 1;

          return order;
      },
      documentOnClick: function (event) {
          var navItems = this.querySelectorAll('nav-item > a');
          for (var i = 0; i < navItems.length; i ++ ) {
              if (!navItems[i].isEqualNode(event.target) &&
                      navItems[i].parentElement.classList.contains('open')) {
                  navItems[i].parentElement.classList.remove('open');
              }
          }
      }
  });
  </script>

</dom-module>

