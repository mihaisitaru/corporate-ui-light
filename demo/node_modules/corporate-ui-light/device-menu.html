<link rel="import" href="../polymer-1.4.0/polymer.html">
<link rel="stylesheet" href="../bootstrap/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="css/font-awesome/all.min.css">
<link rel="stylesheet" href="css/corporate-ui/corporate-ui.css">
<link rel="stylesheet" href="../bootstrap-treeview/dist/bootstrap-treeview.min.css">
<script src="../bootstrap-treeview/dist/bootstrap-treeview.min.js"></script>

<dom-module id="ks-device-menu">
<style>
    :host .node-ksDeviceMenu {
        font-family: "Scania Sans";
        background-color: #f5f5f5;
        padding: 10px 5px;
        font-size: 14px;
        font-weight: 400;
        text-transform: capitalize;
    }
    :host .node-ksDeviceMenu.top-level {
        width: 80%;
        font-size: 14px;
        font-weight: 700;
        overflow: hidden;
        word-break: normal;
        white-space: nowrap;
        text-transform: uppercase;
        text-overflow: ellipsis;
    }
    :host .node-ksDeviceMenu.top-level a {
        font-size: 14px;
        font-weight: 700;
        text-transform: uppercase;
    }
    :host .node-ksDeviceMenu a {
        font-size: 14px;
        font-weight: 400;
        text-transform: capitalize;
    }
    :host #ksDeviceMenu .list-group {
        padding-left: 15px;
        padding-right: 15px;
        margin-bottom: 10px;
        margin-top: 27px;
    }
    :host .node-ksDeviceMenu.node-selected {
        font-family: "Scania Sans ";
        color: #4a8ba4;
        background-color: transparent;
        border-left: 4px solid #d6001c;
    }
    :host .node-ksDeviceMenu.node-expanded {
        font-family: "Scania Sans";
        font-weight: bold;
        color: #041e42;
    }
    :host #customTemplate {
        padding-left: 0;
        cursor: pointer;
    }
    :host #customContent {
        list-style: none;
    }
    :host #customTemplate ul {
        padding-left: 15px;
        padding-right: 15px;
        box-shadow: none;
        border: none;
        background-color: #f5f5f5;
    }
    :host #customTemplate ul > li {
        display: block;
        padding-left: 10px;
        padding-right: 10px;
    }
    :host #customTemplate ul > li > a {
        text-transform: capitalize;
    }
</style>
  <template>
    <div class="visible-xs visible-sm" id="ksDeviceMenu"></div>
      <ul class="visible-xs visible-sm" id="customTemplate"></ul>
  </template>

 <script>
  Polymer({
      is: 'ks-device-menu',
      behaviors: [CUIBehaviors.GlobalBehavior, CUIBehaviors.MenuBehavior],

      ready: function () {
          this.rendered = false;
          document.addEventListener('custom-content-added', this._applyConstumTemplate.bind(this));
          document.addEventListener('click', this._onClick.bind(this));
          this.scopeSubtree(this, true);
          Polymer.RenderStatus.afterNextRender(this, function () {
              if(!this.rendered){
                  this._buildMenu();
                  this.rendered = true;
              }
          }.bind(this));
      },
      _onClick: function (event) {
          var clickOver = event.target,
                  parentNode = this.parentNode.classList,
                  isOpened = parentNode.contains('navbar-collapse') && parentNode.contains('in'),
                  isToggleButton = clickOver.classList.contains('navbar-toggle'),
                  isMenuItem = this.findById(event.path, 'ksDeviceMenu') || this.findById(event.path, 'customTemplate'),
                  isCustomToggle = this.findByAttr(event.path, 'ks-navigation-toggle');

          if (isOpened) {
              if (!isToggleButton && !isMenuItem || isCustomToggle) {
                  this._toggleCollapse();
              }
          }
      },
      _toggleCollapse: function () {
          document.querySelector('button.navbar-toggle').classList.add('collapsed');
          this.parentNode.classList.remove('in');
      },
      _applyConstumTemplate: function (event) {
          event.detail.customContent.appendTo(this.$.customTemplate);
      },
      _menuOption: function(){
          return {
              showBorder: false,
              color: '#909090',
              hoverTextColor: '#041e42',
              collapseIcon: 'none',
              expandIcon: 'none',
              emptyIcon: 'none',
              enableLinks: true,
              customSelectedStyle: 'custom',
              customExpandedStyle: 'custom',
              indentNode: true,
              data: this._formatedNodes(),
              decorator: this._decorate.bind(this),
              onNodeSelected: this._toggleCollapse.bind(this)
          };

      },
      _buildMenu: function () {
          $('#ksDeviceMenu').treeview(this._menuOption());
          $('#ksDeviceMenu').treeview('collapseAll', {silent: true});
      },
      _formatedNodes: function () {
          this.allMenuItems = this.renamePropertiy(this.allMenuItems, 'state', 'stateName', true);
          var formatedItems = [];
          this.allMenuItems.forEach(function(node){
              node = this.renamePropertiy(node, 'items', 'nodes');
              node = this.renamePropertiy(node, 'title', 'text');
              node.selector = 'top-level';
              formatedItems.push(node);

          }, this);
          return formatedItems;
      },
      _decorate: function (node) {
          node.selectable = node.nodes === undefined;
          return node;
      }
  });
  </script>
</dom-module>